å¥½çš„ï¼Œæˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸ªèƒ½è®©ä½ åº”ç”¨å†…éƒ¨å„ä¸ªæ¨¡å—ä¹‹é—´å®ç°ä¼˜é›…è§£è€¦å’Œé€šä¿¡çš„å¼ºå¤§æ¨¡å¼ï¼š**äº‹ä»¶ (Events)**ã€‚è¿™å°±åƒæ˜¯ä¸ºä½ çš„åº”ç”¨å†…éƒ¨å»ºç«‹ä¸€ä¸ªé«˜æ•ˆã€æœ‰åºçš„â€œå¹¿æ’­å’Œè®¢é˜…ç³»ç»Ÿâ€ã€‚

## åº”ç”¨å†…éƒ¨çš„â€œå¹¿æ’­ç«™â€ï¼šç²¾é€š NestJS äº‹ä»¶é©±åŠ¨æ¨¡å¼

æƒ³è±¡ä½ çš„åº”ç”¨æ˜¯ä¸€å®¶å¤§å‹çš„æ–°é—»æœºæ„ã€‚

æœºæ„é‡Œæœ‰å¤šä¸ªç‹¬ç«‹çš„éƒ¨é—¨ï¼š

- **ç¤¾ä¼šæ–°é—»éƒ¨ï¼ˆ`UsersService`ï¼‰**ï¼šè´Ÿè´£æŠ¥é“æ–°ç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶ã€‚
- **è´¢ç»æ–°é—»éƒ¨ï¼ˆ`OrdersService`ï¼‰**ï¼šè´Ÿè´£æŠ¥é“æ–°è®¢å•åˆ›å»ºçš„äº‹ä»¶ã€‚
- **å¸‚åœºæ¨å¹¿éƒ¨ï¼ˆ`MarketingService`ï¼‰**ï¼šå¯¹æ–°ç”¨æˆ·æ³¨å†Œå’Œæ–°è®¢å•åˆ›å»ºéƒ½å¾ˆæ„Ÿå…´è¶£ï¼Œå¸Œæœ›èƒ½æ”¶åˆ°é€šçŸ¥ï¼Œä»¥ä¾¿å‘é€æ¬¢è¿é‚®ä»¶æˆ–ä¼˜æƒ åˆ¸ã€‚
- **æ•°æ®åˆ†æéƒ¨ï¼ˆ`AnalyticsService`ï¼‰**ï¼šä¹Ÿæƒ³çŸ¥é“æ‰€æœ‰è¿™äº›äº‹ä»¶ï¼Œä»¥ä¾¿è¿›è¡Œæ•°æ®ç»Ÿè®¡ã€‚

**æ²¡æœ‰äº‹ä»¶ç³»ç»Ÿçš„â€œä½æ•ˆæ²Ÿé€šâ€æ¨¡å¼ï¼š**
å½“ç¤¾ä¼šæ–°é—»éƒ¨æŠ¥é“äº†ä¸€ä½æ–°ç”¨æˆ·æ³¨å†Œåï¼Œå®ƒéœ€è¦**äº²è‡ª**ã€**æŒ¨ä¸ª**åœ°æ‰“ç”µè¯é€šçŸ¥å¸‚åœºæ¨å¹¿éƒ¨å’Œæ•°æ®åˆ†æéƒ¨ï¼šâ€œå˜¿ï¼Œæˆ‘ä»¬è¿™æœ‰ä¸ªæ–°ç”¨æˆ·ï¼â€```typescript
// users.service.ts (è€¦åˆçš„è®¾è®¡)
export class UsersService {
constructor(
private readonly marketingService: MarketingService, // ç›´æ¥ä¾èµ–
private readonly analyticsService: AnalyticsService, // ç›´æ¥ä¾èµ–
) {}

createUser(dto) {
// ...åˆ›å»ºç”¨æˆ·...
const user = { ... };

    // æŒ¨ä¸ªè°ƒç”¨ï¼Œç´§å¯†è€¦åˆ
    this.marketingService.sendWelcomeEmail(user);
    this.analyticsService.trackUserCreation(user);

    return user;

}
}

````
è¿™ç§æ–¹å¼çš„é—®é¢˜æ˜¯**ç´§å¯†è€¦åˆ (Tight Coupling)**ã€‚å¦‚æœæœªæ¥æ–°å¢ä¸€ä¸ªâ€œå®¢æˆ·å…³æ€€éƒ¨â€ä¹Ÿéœ€è¦è¿™ä¸ªé€šçŸ¥ï¼Œä½ å°±å¿…é¡»å»ä¿®æ”¹ `UsersService` çš„ä»£ç ï¼Œç»™å®ƒå†æ³¨å…¥ä¸€ä¸ªæ–°çš„ä¾èµ–ã€‚è¿™è¿åäº†â€œå¼€é—­åŸåˆ™â€ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰ã€‚

**å¼•å…¥äº‹ä»¶çš„â€œå¹¿æ’­ç«™â€æ¨¡å¼ï¼š**
`UsersService` çš„èŒè´£è¢«ç®€åŒ–äº†ã€‚å½“ä¸€ä¸ªæ–°ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œå®ƒåªéœ€è¦æ‹¿èµ·å¹¿æ’­è¯ç­’ï¼Œå‘å…¨å…¬å¸å¤§å–Šä¸€å£°ï¼šâ€œ**ç‰¹å¤§æ–°é—»ï¼ä¸€ä¸ªåä¸ºâ€˜user.createdâ€™çš„äº‹ä»¶å‘ç”Ÿäº†ï¼è¿™æ˜¯è¯¦ç»†èµ„æ–™ï¼**â€
*   å®ƒ**ä¸å…³å¿ƒ**è°åœ¨å¬è¿™ä¸ªå¹¿æ’­ã€‚
*   å¸‚åœºæ¨å¹¿éƒ¨å’Œæ•°æ®åˆ†æéƒ¨ï¼Œéƒ½æå‰åœ¨è‡ªå·±çš„åŠå…¬å®¤é‡Œå®‰è£…äº†â€œæ”¶éŸ³æœºâ€ï¼Œå¹¶è°ƒåˆ°äº†â€œuser.createdâ€è¿™ä¸ªé¢‘é“ã€‚
*   å½“å¹¿æ’­å“èµ·æ—¶ï¼Œå®ƒä»¬çš„â€œæ”¶éŸ³æœºâ€ï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰å°±ä¼šè‡ªåŠ¨æ”¶åˆ°æ¶ˆæ¯ï¼Œç„¶åå„è‡ªæ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼ˆå‘é‚®ä»¶ã€åšç»Ÿè®¡ï¼‰ã€‚

è¿™ç§æ¨¡å¼å°±æ˜¯**äº‹ä»¶é©±åŠ¨ (Event-Driven)**ã€‚å‘å‡ºäº‹ä»¶çš„ä¸€æ–¹ï¼ˆ**Emitter**ï¼‰å’Œç›‘å¬äº‹ä»¶çš„ä¸€æ–¹ï¼ˆ**Listener**ï¼‰äº’ä¸äº†è§£ï¼Œå®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ç«‹çš„â€œå¹¿æ’­ä¸­å¿ƒâ€ï¼ˆ**EventEmitter**ï¼‰è¿›è¡Œé€šä¿¡ï¼Œå®ç°äº†å®Œç¾çš„**è§£è€¦**ã€‚

NestJS å®˜æ–¹æä¾›äº† **`@nestjs/event-emitter`** æ¨¡å—ï¼Œå®ƒæ˜¯åŸºäº Node.js å†…ç½®çš„ `EventEmitter` å®ç°çš„ï¼Œéå¸¸è½»é‡å’Œé«˜æ•ˆã€‚

### 1. ç¬¬ä¸€æ­¥ï¼šæ­å»ºâ€œå¹¿æ’­ç«™â€ (`EventEmitterModule`)

**ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–**
```bash
npm install @nestjs/event-emitter
````

**ç¬¬äºŒæ­¥ï¼šåœ¨ `AppModule` ä¸­æ³¨å†Œ `EventEmitterModule`**

```typescript
// app.module.ts
import { Module } from '@nestjs/common';
import { EventEmitterModule } from '@nestjs/event-emitter';

@Module({
  imports: [
    // å¯åŠ¨å¹¿æ’­ç«™
    EventEmitterModule.forRoot(),
  ],
  // ...
})
export class AppModule {}
```

å°±è¿™ä¹ˆç®€å•ï¼Œä½ çš„åº”ç”¨ç°åœ¨å·²ç»æ‹¥æœ‰äº†ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„å†…éƒ¨å¹¿æ’­ç³»ç»Ÿã€‚

### 2. ç¬¬äºŒæ­¥ï¼šæ’­å‡ºæ–°é—» (å‘å‡ºäº‹ä»¶)

ä»»ä½•ä¸€ä¸ªæœåŠ¡éƒ½å¯ä»¥æˆä¸ºâ€œæ–°é—»æ’­æŠ¥å‘˜â€ã€‚å®ƒåªéœ€è¦æ³¨å…¥ `EventEmitter2` è¿™ä¸ªæœåŠ¡å³å¯ã€‚

**`src/users/users.service.ts` (è§£è€¦åçš„è®¾è®¡)**

```typescript
import { Injectable } from '@nestjs/common';
import { EventEmitter2 } from '@nestjs/event-emitter';
import { CreateUserDto } from './dto/create-user.dto';

@Injectable()
export class UsersService {
  // 1. æ³¨å…¥ EventEmitter2
  constructor(private readonly eventEmitter: EventEmitter2) {}

  createUser(createUserDto: CreateUserDto) {
    const user = {
      id: 1,
      email: createUserDto.email,
      name: 'John Doe',
    };
    console.log('ğŸ‘¤ [UsersService] ç”¨æˆ·å·²åˆ›å»º:', user);

    // 2. ä½¿ç”¨ eventEmitter.emit() å‘å‡ºä¸€ä¸ªäº‹ä»¶
    // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯äº‹ä»¶åï¼Œæ¨èä½¿ç”¨ "åè¯.åŠ¨è¯è¿‡å»å¼" çš„æ ¼å¼
    // ç¬¬äºŒä¸ªå‚æ•°æ˜¯äº‹ä»¶è´Ÿè½½ (payload)ï¼Œä¹Ÿå°±æ˜¯ä½ æƒ³ä¼ é€’çš„æ•°æ®
    this.eventEmitter.emit('user.created', user);

    return user;
  }
}
```

æ³¨æ„ï¼Œç°åœ¨çš„ `UsersService` å˜å¾—éå¸¸å¹²å‡€ï¼Œå®ƒä¸å†ä¾èµ–ä»»ä½•å…¶ä»–æœåŠ¡ã€‚å®ƒçš„èŒè´£å°±æ˜¯åˆ›å»ºç”¨æˆ·ï¼Œç„¶åâ€œå¹¿è€Œå‘Šä¹‹â€ã€‚

### 3. ç¬¬ä¸‰æ­¥ï¼šæ”¶å¬å¹¿æ’­ (ç›‘å¬äº‹ä»¶)

ä»»ä½•ä¸€ä¸ªæœåŠ¡éƒ½å¯ä»¥æˆä¸ºâ€œå¿ å®å¬ä¼—â€ã€‚å®ƒåªéœ€è¦åœ¨æŸä¸ªæ–¹æ³•ä¸Šä½¿ç”¨ `@OnEvent()` è£…é¥°å™¨ã€‚

**`src/marketing/listeners/user-created.listener.ts`**

```typescript
import { Injectable } from '@nestjs/common';
import { OnEvent } from '@nestjs/event-emitter';

@Injectable()
export class UserCreatedListener {
  // 1. ä½¿ç”¨ @OnEvent() è£…é¥°å™¨æ¥è®¢é˜… 'user.created' äº‹ä»¶
  @OnEvent('user.created')
  handleUserCreatedEvent(payload: any) {
    // payload å°±æ˜¯æˆ‘ä»¬ emit æ—¶ä¼ é€’çš„ user å¯¹è±¡
    console.log('ğŸ“§ [MarketingDept] æ”¶åˆ°æ–°ç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼æ­£åœ¨å‘é€æ¬¢è¿é‚®ä»¶...');
    console.log('æ”¶ä»¶äºº:', payload.email);
    // ... æ‰§è¡Œå‘é€é‚®ä»¶çš„é€»è¾‘ ...
  }
}
```

**`src/analytics/listeners/analytics.listener.ts`**

```typescript
import { Injectable } from '@nestjs/common';
import { OnEvent } from '@nestjs/event-emitter';

@Injectable()
export class AnalyticsListener {
  @OnEvent('user.created')
  trackUserCreation(payload: any) {
    console.log('ğŸ“Š [AnalyticsDept] æ”¶åˆ°æ–°ç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼æ­£åœ¨è®°å½•æ•°æ®...');
    console.log('ç”¨æˆ·ID:', payload.id);
    // ... æ‰§è¡Œæ•°æ®ä¸ŠæŠ¥çš„é€»è¾‘ ...
  }
}
```

æœ€åï¼Œåˆ«å¿˜äº†åœ¨ç›¸åº”çš„æ¨¡å—ä¸­æ³¨å†Œè¿™äº›æœåŠ¡å’Œç›‘å¬å™¨ã€‚

**è¿è¡Œæµç¨‹ï¼š**

1.  å®¢æˆ·ç«¯è¯·æ±‚ `POST /users` æ¥åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ã€‚
2.  `UsersController` è°ƒç”¨ `UsersService.createUser()`ã€‚
3.  `UsersService` åˆ›å»ºç”¨æˆ·ï¼Œç„¶åè°ƒç”¨ `eventEmitter.emit('user.created', user)`ã€‚
4.  â€œå¹¿æ’­ç«™â€(`EventEmitter`) ç«‹å³æŸ¥æ‰¾æ‰€æœ‰è®¢é˜…äº† `user.created` é¢‘é“çš„â€œæ”¶éŸ³æœºâ€ã€‚
5.  å®ƒå‘ç° `UserCreatedListener` å’Œ `AnalyticsListener` éƒ½åœ¨æ”¶å¬ã€‚
6.  `handleUserCreatedEvent` å’Œ `trackUserCreation` æ–¹æ³•è¢«**å¼‚æ­¥åœ°**ã€**å¹¶è¡Œåœ°**è°ƒç”¨ï¼Œå®ƒä»¬å„è‡ªæ‰§è¡Œè‡ªå·±çš„é€»è¾‘ã€‚
7.  `UsersService` çš„ `createUser` æ–¹æ³•æ— éœ€ç­‰å¾…ç›‘å¬å™¨æ‰§è¡Œå®Œæˆï¼Œç›´æ¥è¿”å›å“åº”ç»™ Controllerã€‚

### 4. â€œå¹¿æ’­â€çš„é«˜çº§ç©æ³•

#### **é€šé…ç¬¦ç›‘å¬**

ä½ å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ `*` æ¥ç›‘å¬ä¸€ç±»äº‹ä»¶ã€‚

```typescript
// analytics.listener.ts
@OnEvent('*.created') // ç›‘å¬æ‰€æœ‰ä»¥ .created ç»“å°¾çš„äº‹ä»¶
handleAnyCreationEvent(payload: any) {
  console.log('ğŸ“Š [AnalyticsDept] ç›‘å¬åˆ°ä¸€ä¸ªåˆ›å»ºäº‹ä»¶ï¼');
}
```

ç°åœ¨ï¼Œæ— è®ºæ˜¯ `user.created` è¿˜æ˜¯ `order.created`ï¼Œè¿™ä¸ªç›‘å¬å™¨éƒ½ä¼šè¢«è§¦å‘ã€‚

#### **å¼‚æ­¥ç›‘å¬å™¨**

é»˜è®¤æƒ…å†µä¸‹ï¼Œäº‹ä»¶ç›‘å¬å™¨æ˜¯**å¼‚æ­¥**çš„ï¼ˆ`async`ï¼‰ï¼Œå¹¶ä¸” `emit()` æ–¹æ³•æ˜¯**â€œå³å‘å³å¿˜â€ (fire-and-forget)** çš„ï¼Œå®ƒä¸ä¼šç­‰å¾…ç›‘å¬å™¨æ‰§è¡Œå®Œæˆã€‚

å¦‚æœä½ å¸Œæœ›**ç­‰å¾…**æ‰€æœ‰ç›‘å¬å™¨éƒ½æ‰§è¡Œå®Œæ¯•åå†ç»§ç»­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `emitAsync()`ã€‚

```typescript
// users.service.ts
async createUser(dto) {
  // ...
  console.log('æ­£åœ¨å‘å‡ºäº‹ä»¶ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰ç›‘å¬å™¨å®Œæˆ...');
  await this.eventEmitter.emitAsync('user.created.sync', user);
  console.log('æ‰€æœ‰ç›‘å¬å™¨éƒ½å·²æ‰§è¡Œå®Œæ¯•ï¼');
  return user;
}
```

### æ€»ç»“

`@nestjs/event-emitter` æ˜¯å®ç°åº”ç”¨å†…æ¨¡å—è§£è€¦çš„å¼ºå¤§å·¥å…·ï¼Œå®ƒéµå¾ªç»å…¸çš„â€œå‘å¸ƒ-è®¢é˜…â€æ¨¡å¼ã€‚

| è§’è‰²                 | æ ¸å¿ƒ API                            | èŒè´£                                     |
| :------------------- | :---------------------------------- | :--------------------------------------- |
| **å¹¿æ’­ç«™ (ä¸­å¿ƒ)**    | `EventEmitterModule.forRoot()`      | æä¾›äº‹ä»¶é€šä¿¡çš„åŸºç¡€è®¾æ–½ã€‚                 |
| **æ’­æŠ¥å‘˜ (Emitter)** | æ³¨å…¥ `EventEmitter2`ï¼Œè°ƒç”¨ `emit()` | **åªè´Ÿè´£å‘å‡ºäº‹ä»¶**ï¼Œä¸å…³å¿ƒè°æ¥å¤„ç†ã€‚     |
| **å¬ä¼— (Listener)**  | åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ `@OnEvent()` è£…é¥°å™¨    | **åªè´Ÿè´£å“åº”äº‹ä»¶**ï¼Œä¸å…³å¿ƒäº‹ä»¶ç”±è°å‘å‡ºã€‚ |

å½“ä½ å‘ç°ä½ çš„ä¸€ä¸ªæœåŠ¡å¼€å§‹ `import` å’Œ `inject` è¶Šæ¥è¶Šå¤šä¸ç›´æ¥ç›¸å…³çš„å…¶ä»–æœåŠ¡ï¼Œä»…ä»…æ˜¯ä¸ºäº†åœ¨æŸä¸ªåŠ¨ä½œå®Œæˆåâ€œé€šçŸ¥â€å®ƒä»¬ä¸€ä¸‹æ—¶ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼ºçƒˆçš„ä¿¡å·ï¼šæ˜¯æ—¶å€™å¼•å…¥äº‹ä»¶é©±åŠ¨ï¼Œå»ºç«‹ä½ çš„å†…éƒ¨â€œå¹¿æ’­ç«™â€ï¼Œè®©ä½ çš„æ¨¡å—ä»¬å„è‡ªç‹¬ç«‹ã€é«˜æ•ˆåœ°å·¥ä½œäº†ã€‚
